<!-- templates/surveys/upload_clients.html -->
{% extends 'base.html' %}
{% block content %}
<h2>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ Excel</h2>

{% if not preview_data %}
  <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ -->
  <div class="card">
    <div class="card-body">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3">
          <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ Excel-—Ñ–∞–π–ª (.xlsx)</label>
          <input type="file" name="excel_file" accept=".xlsx" class="form-control" required>
          <div class="form-text">
            –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü: <code>full_name</code><br>
            –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: <code>holding</code>, <code>employee_full_name</code>, <code>phone</code>, <code>email</code>
          </div>
        </div>
        <button name="preview" value="1" class="btn btn-primary">üîç –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
      </form>
    </div>
  </div>

{% else %}
  <!-- –®–∞–≥ 2: –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
  <div class="alert alert-info">
    –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π: <strong>{{ valid_count }}</strong>,
    —Å –æ—à–∏–±–∫–∞–º–∏: <strong>{{ invalid_count }}</strong>
  </div>

  <div style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px;">
    <table class="table table-sm mb-0">
      <thead class="table-light">
        <tr>
          <th>–ù–∞–∑–≤–∞–Ω–∏–µ / –§–ò–û</th>
          <th>–•–æ–ª–¥–∏–Ω–≥</th>
          <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
          <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
          <th>Email</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
        </tr>
      </thead>
      <tbody>
        {% for item in preview_data %}
          <tr class="{% if item.errors %}table-danger{% else %}table-success{% endif %}">
            <td>{{ item.full_name }}</td>
            <td>{{ item.holding|default:"‚Äî" }}</td>
            <td>{{ item.employee_full_name|default:"‚Äî" }}</td>
            <td>{{ item.phone|default:"‚Äî" }}</td>
            <td>{{ item.email|default:"‚Äî" }}</td>
            <td>
              {% if item.errors %}
                <small class="text-danger">
                  {% for err in item.errors %}
                    {{ err }}<br>
                  {% endfor %}
                </small>
              {% else %}
                <span class="text-success">OK</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if valid_count > 0 %}
    <form method="post" class="mt-3">
      {% csrf_token %}
      <button name="confirm_upload" value="1" class="btn btn-success">
        ‚úÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å {{ valid_count }} –∑–∞–ø–∏—Å–µ–π
      </button>
      <a href="{% url 'upload_clients' %}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
    </form>
  {% endif %}
{% endif %}
{% endblock %}