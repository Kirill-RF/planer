{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}{{ title }} | {% trans 'Администрирование Django' %}{% endblock %}

{% block content %}
<div id="content-main">
    <div class="module">
        <h2>{{ title }}</h2>
        
        <!-- Общая статистика -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h3>{{ total_responses }}</h3>
                        <p>Всего ответов</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h3>{{ unique_clients }}</h3>
                        <p>Уникальных клиентов</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h3>{{ task.target_count }}</h3>
                        <p>План</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h3>{{ task.current_count }}</h3>
                        <p>Выполнено</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Горизонтальный график ответов по вопросам -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">Горизонтальный график ответов по вопросам</h5>
            </div>
            <div class="card-body">
                {% for question_stat in questions_stats %}
                    <div class="mb-4 p-3 border rounded">
                        <h6>{{ question_stat.question.question_text }}</h6>
                        
                        {% if question_stat.choice_stats %}
                            <!-- Вопросы с вариантами ответов - отображаем отдельные линии для каждого варианта -->
                            {% for choice_stat in question_stat.choice_stats %}
                                <div class="d-flex align-items-center mb-2">
                                    <span class="me-3" style="width: 200px; font-weight: bold;">
                                        {{ choice_stat.choice.choice_text }}
                                    </span>
                                    <div class="progress" style="flex-grow: 1; height: 20px;">
                                        <div class="progress-bar" 
                                             role="progressbar" 
                                             style="width: {{ choice_stat.percentage }}%; 
                                                    background-color: {% if forloop.counter == 1 %}#28a745{% elif forloop.counter == 2 %}#ffc107{% elif forloop.counter == 3 %}#dc3545{% else %}#6c757d{% endif %};"
                                             aria-valuenow="{{ choice_stat.percentage }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ choice_stat.count }} ({{ choice_stat.percentage }}%)
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            
                            <!-- Легенда под всеми линиями -->
                            <div class="mt-2">
                                <strong>Легенда:</strong>
                                <div class="d-flex flex-wrap">
                                    {% for choice_stat in question_stat.choice_stats %}
                                        <div class="d-flex align-items-center me-3">
                                            <div style="width: 12px; height: 12px; background-color: {% if forloop.counter == 1 %}#28a745{% elif forloop.counter == 2 %}#ffc107{% elif forloop.counter == 3 %}#dc3545{% else %}#6c757d{% endif %}; margin-right: 5px;"></div>
                                            <span>{{ choice_stat.choice.choice_text }}</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                        {% elif question_stat.text_answers_count %}
                            <!-- Текстовые вопросы -->
                            <p>Текстовых ответов: {{ question_stat.text_answers_count }}</p>
                        {% else %}
                            <!-- Фото вопросы -->
                            <div class="accordion" id="photoAccordion{{ question_stat.question.id }}">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading{{ question_stat.question.id }}">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ question_stat.question.id }}" aria-expanded="false" aria-controls="collapse{{ question_stat.question.id }}">
                                            Фото ({{ question_stat.total_answers }} ответов) - нажмите для просмотра
                                        </button>
                                    </h2>
                                    <div id="collapse{{ question_stat.question.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ question_stat.question.id }}" data-bs-parent="#photoAccordion{{ question_stat.question.id }}">
                                        <div class="accordion-body">
                                            {% for answer in question_stat.question.answers.all %}
                                                {% for photo in answer.photos.all %}
                                                    <div class="mb-3">
                                                        <img src="{{ photo.photo.url }}" alt="Фото" style="max-width: 200px; max-height: 200px; object-fit: cover;">
                                                        <p class="mt-2">Клиент: {{ answer.client.name }}</p>
                                                        <small>Дата: {{ photo.created_at|date:"d.m.Y H:i" }}</small>
                                                    </div>
                                                {% empty %}
                                                    <p>Нет фото для этого вопроса</p>
                                                {% endfor %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Кнопка "Назад к задачам" -->
        <a href="{% url 'admin:tasks_task_changelist' %}" class="btn btn-secondary">
            {% trans 'Назад к задачам' %}
        </a>
    </div>
</div>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}